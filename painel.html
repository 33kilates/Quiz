<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMANDO: Controle de Reten√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #050505;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }

        .cyber-card {
            border: 1px solid #1a1a1a;
            background: #0a0a0a;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .cyber-header {
            border-bottom: 1px solid #333;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .stat-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .funnel-bar {
            height: 1.5rem;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .funnel-fill {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 1s ease;
            opacity: 0.7;
        }

        .alert-red {
            color: #ff0000;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .alert-bg {
            background: rgba(255, 0, 0, 0.1);
        }

        /* Grid Pattern */
        .bg-grid {
            background-image: linear-gradient(#111 1px, transparent 1px),
                linear-gradient(90deg, #111 1px, transparent 1px);
            background-size: 20px 20px;
        }

        input[type="date"] {
            background: #111;
            color: #0f0;
            border: 1px solid #333;
            padding: 4px 8px;
            font-family: inherit;
        }
    </style>
</head>

<body class="bg-grid min-h-screen p-6 md:p-12">

    <div class="max-w-6xl mx-auto space-y-12">

        <!-- Header & Filters -->
        <header class="flex flex-col md:flex-row justify-between items-end border-b border-green-900/50 pb-6 gap-6">
            <div>
                <h1 class="text-3xl font-bold tracking-tighter text-white">RAIO-X <span
                        class="text-green-500">RETEN√á√ÉO</span></h1>
                <p class="text-xs text-green-700 mt-2">DADOS REAIS // SEM SIMULA√á√ÉO</p>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex gap-2 items-center">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-500">IN√çCIO</label>
                        <input type="date" id="date-start" onchange="fetchData()">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-500">FIM</label>
                        <input type="date" id="date-end" onchange="fetchData()">
                    </div>
                </div>

                <div class="text-right">
                    <div class="text-xs text-gray-500">STATUS</div>
                    <div id="connection-status" class="text-green-400 font-bold text-xs">ONLINE</div>
                    <button onclick="fetchData()"
                        class="mt-2 text-[10px] border border-green-800 text-green-800 px-3 py-1 hover:bg-green-900/20 transition">ATUALIZAR</button>
                </div>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="cyber-card p-6 rounded relative overflow-hidden">
                <div class="stat-label">Visitantes Totais</div>
                <div id="total-visits" class="stat-value text-white">0</div>
                <div class="absolute top-0 right-0 p-2 opacity-20 text-4xl">üëÄ</div>
            </div>
            <div class="cyber-card p-6 rounded relative overflow-hidden">
                <div class="stat-label">Leads Gerados</div>
                <div id="total-leads" class="stat-value text-green-400">0</div>
                <div class="absolute top-0 right-0 p-2 opacity-20 text-4xl">üí∞</div>
            </div>
            <div class="cyber-card p-6 rounded relative overflow-hidden">
                <div class="stat-label">Taxa de Convers√£o</div>
                <div id="conversion-rate" class="stat-value text-blue-400">0%</div>
                <div class="absolute top-0 right-0 p-2 opacity-20 text-4xl">üìà</div>
            </div>
            <div class="cyber-card p-6 rounded relative overflow-hidden border-red-900/30">
                <div class="stat-label text-red-700">Ponto de Fuga Cr√≠tico</div>
                <div id="worst-dropoff" class="text-xl font-bold text-red-500 mt-2">--</div>
                <div class="absolute top-0 right-0 p-2 opacity-20 text-4xl">‚ö†Ô∏è</div>
            </div>
        </div>

        <!-- Funnel View -->
        <div class="cyber-card p-8 rounded-lg">
            <h2 class="text-xl text-white mb-8 border-l-4 border-green-500 pl-4">AN√ÅLISE DE FUNIL</h2>
            <div id="funnel-container" class="space-y-6 text-center text-gray-500 py-12">
                Carregando dados do servidor...
            </div>
        </div>

    </div>

    <script>
        // Init Dates (Last 7 Days)
        const today = new Date();
        const lastWeek = new Date();
        lastWeek.setDate(today.getDate() - 7);

        document.getElementById('date-end').valueAsDate = today;
        document.getElementById('date-start').valueAsDate = lastWeek;

        async function fetchData() {
            const startInput = document.getElementById('date-start').value;
            const endInput = document.getElementById('date-end').value;
            const container = document.getElementById('funnel-container');
            const statusLabel = document.getElementById('connection-status');

            statusLabel.innerText = "BUSCANDO...";

            try {
                const res = await fetch('/.netlify/functions/analytics');
                if (res.ok) {
                    const data = await res.json();
                    const history = data.history || {};

                    // AGGREGATE DATA BASED ON DATE RANGE
                    const aggregated = {
                        visits: 0, start: 0, q1: 0, q2: 0, q3: 0, q4: 0, q5: 0, q6: 0, leads: 0
                    };

                    let hasData = false;

                    for (const [dateStr, stats] of Object.entries(history)) {
                        if (dateStr >= startInput && dateStr <= endInput) {
                            hasData = true;
                            for (const key in aggregated) {
                                aggregated[key] += (stats[key] || 0);
                            }
                        }
                    }

                    renderFunnel(aggregated, hasData);
                    statusLabel.innerText = "ONLINE (v1.1)";
                    statusLabel.style.color = "#10b981"; // Emerald
                    return;
                } else {
                    // Try to get error text
                    const errText = await res.text();
                    statusLabel.innerText = `ERRO ${res.status}: ${errText.substring(0, 50)}`;
                    statusLabel.style.color = "#ef4444"; // Red
                    console.error("Analytics Error:", errText);
                }
            } catch (e) {
                statusLabel.innerText = `ERRO JS: ${e.message}`;
                statusLabel.style.color = "#ef4444";
                console.error(e);
            }

            // If error or empty logic handled above

            renderFunnel({ visits: 0, start: 0, q1: 0, q2: 0, q3: 0, q4: 0, q5: 0, q6: 0, leads: 0 }, false);
        }

        function renderFunnel(data, hasData) {
            const container = document.getElementById('funnel-container');

            if (!hasData && data.visits === 0) {
                container.innerHTML = `
                    <div class="py-12 border border-dashed border-gray-800 rounded">
                        <p class="text-gray-500 font-mono">NENHUM DADO ENCONTRADO NO PER√çODO SELECIONADO</p>
                        <p class="text-xs text-gray-700 mt-2">Aguardando tr√°fego...</p>
                    </div>
                `;
                // Zero stats
                document.getElementById('total-visits').innerText = "0";
                document.getElementById('total-leads').innerText = "0";
                document.getElementById('conversion-rate').innerText = "0%";
                document.getElementById('worst-dropoff').innerText = "--";
                return;
            }

            const steps = [
                { key: 'visits', label: 'Tela Inicial (Visitas)', count: data.visits || 0 },
                { key: 'start', label: 'Iniciou Quiz', count: data.start || 0 },
                { key: 'q1', label: 'Q1: Volume', count: data.q1 || 0 },
                { key: 'q2', label: 'Q2: Sangria', count: data.q2 || 0 },
                { key: 'q3', label: 'Q3: Blindagem', count: data.q3 || 0 },
                { key: 'q4', label: 'Q4: Doen√ßa', count: data.q4 || 0 },
                { key: 'q5', label: 'Q5: CEO', count: data.q5 || 0 },
                { key: 'q6', label: 'Q6: Ultimato', count: data.q6 || 0 },
                { key: 'leads', label: 'Visualizou Diagn√≥stico (Leads)', count: data.leads || 0 }
            ];

            const max = steps[0].count || 1;
            container.innerHTML = '';

            // Update KPIs
            document.getElementById('total-visits').innerText = steps[0].count;
            const leadCount = steps[steps.length - 1].count;
            document.getElementById('total-leads').innerText = leadCount;
            document.getElementById('conversion-rate').innerText = max > 0 ? ((leadCount / max) * 100).toFixed(1) + '%' : '0%';

            let worstDrop = { step: '', percent: 0 };

            steps.forEach((step, index) => {
                const prev = index > 0 ? steps[index - 1].count : step.count;
                // Avoid division by zero
                const safePrev = prev === 0 ? 1 : prev;

                const ret = prev > 0 ? (step.count / prev) * 100 : 0;
                const drop = 100 - ret;

                // Track worst drop (ignore step 0)
                if (index > 0 && drop > worstDrop.percent && prev > 0) {
                    worstDrop = { step: step.label, percent: drop };
                }

                // Visual Bars
                // Calculate width relative to Max (visits) to show absolute funnel shape
                const width = max > 0 ? (step.count / max) * 100 : 0;

                const colorClass = drop > 25 && index > 0 ? 'bg-red-500' : 'bg-green-500';
                const textClass = drop > 25 && index > 0 ? 'text-red-500' : 'text-green-500';

                const html = `
                    <div class="relative group">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-white font-bold tracking-widest text-xs md:text-sm">${step.label}</span>
                            <div class="flex gap-4">
                                <span class="text-gray-500">${step.count}</span>
                                <span class="${textClass} font-mono w-16 text-right font-bold">${index === 0 ? '100%' : ret.toFixed(1) + '%'}</span>
                            </div>
                        </div>
                        <div class="funnel-bar">
                            <div class="funnel-fill ${colorClass}" style="width: ${width}%"></div>
                            
                            <!-- Tooltip showing drop -->
                            ${index > 0 ? `
                            <div class="absolute inset-0 flex items-center pl-2 opacity-50 group-hover:opacity-100 transition duration-300">
                                <span class="text-[10px] text-black font-bold uppercase bg-white/80 px-1 rounded">Perda: -${drop.toFixed(1)}%</span>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            document.getElementById('worst-dropoff').innerText = worstDrop.percent > 0
                ? `${worstDrop.step} (-${worstDrop.percent.toFixed(1)}%)`
                : "Sem perdas";
        }

        // Init load
        fetchData();
    </script>
</body>

</html>